<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Pagamento</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/Pagamento.css">
</head>
<body>

<header class="logo">
    <img src="img/Logo.jpg" alt="Logo da empresa">
</header>

<nav class="menu-principal">
    <a href="index.html" class="menu-item">Início</a>
    <a href="cadastrarFuncionario.html" class="menu-item">Cadastrar Funcionário</a>
    <a href="registroHora.html" class="menu-item">Registrar Horas</a>
    <a href="historicoPagamentos.html" class="menu-item">Histórico de Pagamentos</a>
</nav>

<main class="container">
    <h2>Registrar Pagamento</h2>

    <form id="formPagamento" class="formulario">
        <label for="funcionario">Funcionário:</label>
        <select id="funcionario" required>
            <option value="">Selecione o funcionário</option>
        </select>

        <label for="inicioPeriodo">Início do Período (Referência):</label>
        <input type="date" id="inicioPeriodo" required>
        
        <label for="fimPeriodo">Fim do Período (Referência):</label>
        <input type="date" id="fimPeriodo" required>

        <label for="valorTotal">Valor Bruto (R$):</label>
        <input type="number" id="valorTotal" step="0.01" value="0.00" required>
        
        <label for="descontos">Descontos (R$):</label>
        <input type="number" id="descontos" step="0.01" value="0">

        <label for="observacoes">Observações:</label>
        <textarea id="observacoes" rows="3" placeholder="Ex: atraso, adiantamento, etc."></textarea>

        <div id="valoresCalculados" style="margin: 10px 0; font-weight: bold;">
            Valor Total: R$ 0.00 | Valor Líquido: R$ 0.00
        </div>

        <button type="submit" class="menu-item">Salvar Pagamento</button>
    </form>
</main>

<footer class="rodape">
    <div class="rodape-container">
        <p>&copy; 2025 Sistema Sete Cores Funcionários</p>
    </div>
</footer>

<script>
    // URL base do backend
    const API_URL = "http://localhost:8080";

    // --- FUNÇÕES DE CARREGAMENTO E FEEDBACK ---

    async function carregarFuncionarios() {
        try {
            const response = await fetch(`${API_URL}/funcionarios`);
            if (!response.ok) throw new Error("Erro ao carregar funcionários");

            const funcionarios = await response.json();
            const select = document.getElementById("funcionario");
            funcionarios.forEach(f => {
                const option = document.createElement("option");
                option.value = f.id;
                option.textContent = f.nome;
                select.appendChild(option);
            });
        } catch (err) {
            console.error("Erro ao carregar funcionários:", err);
            alert("Erro de conexão ou falha ao carregar a lista de funcionários.");
        }
    }
    
    // Atualiza o display de valores líquidos em tempo real
    function atualizarValores() {
        const valorTotal = parseFloat(document.getElementById("valorTotal").value || 0);
        const descontos = parseFloat(document.getElementById("descontos").value || 0);
        const valorLiquido = valorTotal - descontos;
        
        document.getElementById("valoresCalculados").textContent =
            `Valor Total: R$ ${valorTotal.toFixed(2)} | Valor Líquido: R$ ${valorLiquido.toFixed(2)}`;
    }

    // --- FUNÇÃO DE SALVAMENTO (POST) ---

    document.getElementById("formPagamento").addEventListener("submit", async (e) => {
        e.preventDefault();
        const funcionarioId = document.getElementById("funcionario").value;
        const inicioPeriodo = document.getElementById("inicioPeriodo").value;
        const fimPeriodo = document.getElementById("fimPeriodo").value;
        
        // NOVO: Extrair o valor total digitado
        const valorTotal = parseFloat(document.getElementById("valorTotal").value || 0); 
        
        const descontos = parseFloat(document.getElementById("descontos").value || 0);
        const observacoes = document.getElementById("observacoes").value;

        if (!funcionarioId || !inicioPeriodo || !fimPeriodo || valorTotal <= 0) {
            alert("Preencha todos os campos e garanta que o Valor Bruto seja maior que zero.");
            return;
        }

        // URL corrigida para o fluxo manual, incluindo 'valorTotal'
        const url = `${API_URL}/pagamentos/${funcionarioId}?inicio=${inicioPeriodo}&fim=${fimPeriodo}&valorTotal=${valorTotal}&descontos=${descontos}&observacoes=${encodeURIComponent(observacoes)}`;
        
        try {
            const response = await fetch(url, {
                method: "POST"
            });
            
            if (response.ok) {
                alert("Pagamento registrado com sucesso!");
                document.getElementById("formPagamento").reset();
                document.getElementById("valoresCalculados").textContent = "Valor Total: R$ 0.00 | Valor Líquido: R$ 0.00";
            } else {
                const errorText = await response.text();
                alert(`Erro ao registrar pagamento! Detalhe: ${errorText}`);
            }
        } catch (err) {
            console.error("Erro no salvamento:", err);
            alert("Erro de conexão com o backend.");
        }
    });

    // --- EXECUÇÃO INICIAL E LISTENERS ---
    
    // Executa ao carregar a página
    carregarFuncionarios();
    
    // Adiciona listeners para feedback em tempo real
    document.getElementById("valorTotal").addEventListener("input", atualizarValores);
    document.getElementById("descontos").addEventListener("input", atualizarValores);
    
    // Inicializa o display de valores
    atualizarValores(); 
</script>

</body>
</html>