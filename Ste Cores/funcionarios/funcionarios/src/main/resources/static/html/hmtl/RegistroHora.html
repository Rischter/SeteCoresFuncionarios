


<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Horas</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="../../../css/RegistroHora.css"> 
    
    </head>
<body>

    <header class="logo">
        <img src="img/Logo.jpg" alt="Logo da empresa">
    </header>

    <nav class="menu-principal">
        <a href="index.html" class="menu-item">Início</a>
        <a href="cadastrarFuncionario.html" class="menu-item">Cadastrar Funcionário</a>
        <a href="registroHora.html" class="menu-item">Registrar Horas</a> <a href="pagamentos.html" class="menu-item">Registrar Pagamento</a>
        <a href="historicoPagamentos.html" class="menu-item">Histórico de Pagamentos</a>
    </nav>

    <main class="container-form container"> <h2>Registrar Horas Trabalhadas</h2>

        <form id="registroHoraForm" class="formulario">

            <label for="funcionario">Funcionário:</label>
            <select id="funcionario" name="funcionario" required>
                <option value="">Selecione o funcionário</option>
            </select>

            <label for="data">Data:</label>
            <input type="date" id="data" name="data" required>

            <label for="entrada">Entrada:</label>
            <input type="time" id="entrada" name="entrada" required>

            <label for="intervalo">Saída para Intervalo:</label>
            <input type="time" id="intervalo" name="intervalo">

            <label for="retorno">Retorno do Intervalo:</label>
            <input type="time" id="retorno" name="retorno">

            <label for="saida">Saída:</label>
            <input type="time" id="saida" name="saida" required>
            
            <label for="horasTrabalhadas">Horas Trabalhadas (Calculado):</label>
            <input type="text" id="horasTrabalhadas" name="horasTrabalhadas" readonly placeholder="Calculado Automaticamente">


            <label for="horaExtra">Horas Extras (Manual):</label>
            <input type="number" id="horaExtra" name="horaExtra" step="0.01" value="0.00" placeholder="Ex: 1.5">

            <label for="observacoes">Observações:</label>
            <textarea id="observacoes" name="observacoes" rows="4" placeholder="Anotações do dia..."></textarea>

            <button type="submit" style="margin-top: 20px;">Salvar Registro</button>

        </form>
    </main>

    <footer class="rodape">
        <div class="rodape-container">
            <p>&copy; 2025 Sistema Sete Cores Funcionários</p>
        </div>
    </footer>

    <script>
        const API_URL = "http://localhost:8080";

        // Funções de Utilitário de Tempo
        function timeToMinutes(time) {
            if (!time) return 0;
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToHours(totalMinutes) {
            if (totalMinutes < 0) return 0;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            // Retorna no formato decimal com 2 casas
            return (hours + minutes / 60).toFixed(2);
        }
        
        // Função de Cálculo de Jornada
        function calcularJornada() {
            const entrada = document.getElementById("entrada").value;
            const intervalo = document.getElementById("intervalo").value;
            const retorno = document.getElementById("retorno").value;
            const saida = document.getElementById("saida").value;

            const minEntrada = timeToMinutes(entrada);
            const minSaida = timeToMinutes(saida);
            const minIntervaloSaida = timeToMinutes(intervalo);
            const minIntervaloRetorno = timeToMinutes(retorno);

            let totalMinutes = 0;
            
            if (minEntrada > 0 && minSaida > 0) {
                // Cálculo da jornada principal
                totalMinutes = minSaida - minEntrada;
                
                // Subtrai o intervalo, se preenchido e válido
                if (minIntervaloSaida > 0 && minIntervaloRetorno > 0) {
                    const intervaloDuracao = minIntervaloRetorno - minIntervaloSaida;
                    if (intervaloDuracao > 0) {
                        totalMinutes -= intervaloDuracao;
                    }
                }
            }

            const horasTrabalhadas = minutesToHours(totalMinutes);
            document.getElementById("horasTrabalhadas").value = horasTrabalhadas;
            return parseFloat(horasTrabalhadas);
        }

        // Listener para recalcular a jornada sempre que os campos de hora mudam
        document.querySelectorAll('#entrada, #intervalo, #retorno, #saida').forEach(input => {
            input.addEventListener('change', calcularJornada);
        });


        // Carregar lista de funcionários da API
        async function carregarFuncionarios() {
            try {
                const response = await fetch(`${API_URL}/funcionarios`);
                if (!response.ok) throw new Error("Erro ao carregar lista de funcionários.");

                const funcionarios = await response.json();
                const select = document.getElementById("funcionario");

                funcionarios.forEach(f => {
                    const option = document.createElement("option");
                    option.value = f.id;
                    option.textContent = f.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar funcionários:", error);
                alert("Não foi possível carregar a lista de funcionários. Verifique o backend.");
            }
        }

        // Enviar registro de horas
        document.getElementById("registroHoraForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const totalJornada = calcularJornada();
            
            // --- VALIDAÇÕES CRÍTICAS DE TEMPO ---
            const minEntrada = timeToMinutes(document.getElementById("entrada").value);
            const minSaida = timeToMinutes(document.getElementById("saida").value);
            const minIntervaloSaida = timeToMinutes(document.getElementById("intervalo").value);
            const minIntervaloRetorno = timeToMinutes(document.getElementById("retorno").value);

            if (minEntrada >= minSaida) {
                return alert("A hora de Entrada deve ser anterior à hora de Saída.");
            }
            if (minIntervaloSaida > 0 && minIntervaloRetorno > 0 && minIntervaloSaida >= minIntervaloRetorno) {
                return alert("O Retorno do Intervalo deve ser após a Saída para o Intervalo.");
            }
            if (totalJornada <= 0) {
                 return alert("A jornada calculada resultou em 0 horas ou um valor negativo. Verifique os horários.");
            }

            // Prepara os dados para o backend
            const registroHoras = {
                funcionario: { id: document.getElementById("funcionario").value },
                data: document.getElementById("data").value,
                entrada: document.getElementById("entrada").value,
                intervaloSaida: document.getElementById("intervalo").value || null, // Se vazio, envia null
                intervaloRetorno: document.getElementById("retorno").value || null, // Se vazio, envia null
                saida: document.getElementById("saida").value,
                // O Backend deve calcular a jornada total, mas enviamos as horas trabalhadas calculadas aqui:
                horasNormais: totalJornada, 
                horasExtras: parseFloat(document.getElementById("horaExtra").value) || 0.00,
                observacoes: document.getElementById("observacoes").value
            };

            try {
                const response = await fetch(`${API_URL}/registroHoras`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(registroHoras)
                });

                if (response.ok) {
                    alert("✅ Registro salvo com sucesso!");
                    document.getElementById("registroHoraForm").reset();
                    document.getElementById("horasTrabalhadas").value = ""; // Limpa campo calculado
                } else {
                    const errorText = await response.text();
                    alert(`❌ Erro ao salvar registro! Detalhe: ${errorText}`);
                }
            } catch (error) {
                console.error("Erro na conexão:", error);
                alert("❌ Falha na comunicação com o servidor.");
            }
        });

        // Execução inicial
        carregarFuncionarios();
    </script>
</body>
</html>